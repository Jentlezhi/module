//
//  CYTCustomTabbarController.m
//  CYTEasyPass
//
//  Created by xujunquan on 17/4/21.
//  Copyright © 2017年 EasyPass. All rights reserved.
//

#import "CYTCustomTabbarController.h"
#import "CYTPersonalHome.h"
#import "CYTPrestrainManager.h"
#import "CYTCarTradeCircleCtr.h"
#import "CYTNavigationController.h"
#import "CYTHomeViewController.h"
#import "CYTCarSourceListViewController.h"
#import "CYTFindCarListViewController.h"
#import "CYTUpdateManager.h"
#import "AFNetworkReachabilityManager.h"

@interface CYTCustomTabbarController ()
@property (nonatomic, strong) CYTPrestrainManager *prestrainManager;
@property (nonatomic, strong) CYTCarTradeCircleCtr *carFriendsCtr;
/** 主页控制器 */
@property(strong, nonatomic) CYTHomeViewController *homeVC;
@end

@implementation CYTCustomTabbarController

- (void)viewDidLoad {
    [super viewDidLoad];

    //检测网络网络状态
    [self netStateHandle];
    //统一设置系统控件属性
    [self appearanceConfig];
    //创建tabbar
    [self createTabbarControllers];
    //检测更新
    [CYTUpdateManager update];
    //app数据预加载
    [self.prestrainManager prestrainAppData];
    [self.prestrainManager updateTokenAndAuthInfo];
}

- (void)createTabbarControllers {
    NSArray *titleArray = @[@"首页",@"车源",@"寻车",@"车商圈",@"我"];
    NSArray *imageArray = @[@"btn_lab_1_",@"btn_lab_2_",@"btn_lab_3_",@"btn_lab_4_",@"btn_lab_5_"];
    
    [self createControllersWithTitleArray:titleArray];
    [self tabBarItemTitles:titleArray tabBarItemImages:imageArray];
}

- (void)netStateHandle {
    [CYTAppManager sharedAppManager].reachableBlock = ^(BOOL reachable) {
        if (reachable) {
             [self.carFriendsCtr reloadView];
        }
    };
}

//设置系统控件属性
- (void)appearanceConfig{
    // 通过appearance统一设置UITabBarItem的文字属性
    NSMutableDictionary *attrs = [NSMutableDictionary dictionary];
    attrs[NSFontAttributeName] = [UIFont systemFontOfSize:11];
    attrs[NSForegroundColorAttributeName] = kContentMainColor;
    
    NSMutableDictionary *selectedAttrs = [NSMutableDictionary dictionary];
    selectedAttrs[NSFontAttributeName] = [UIFont systemFontOfSize:11];
    selectedAttrs[NSForegroundColorAttributeName] = kGreenNormal;
    
    UITabBarItem *item = [UITabBarItem appearance];
    [item setTitleTextAttributes:attrs forState:UIControlStateNormal];
    [item setTitleTextAttributes:selectedAttrs forState:UIControlStateSelected];
}

- (void)createControllersWithTitleArray:(NSArray *)titleArray{
    //首页
    CYTHomeViewController *homeCtr = [CYTHomeViewController new];
    self.homeVC = homeCtr;
    CYTNavigationController *homeNav = [[CYTNavigationController alloc] initWithRootViewController:homeCtr];
    
    //车源
    CYTCarSourceListViewController *carSourceCtr = [CYTCarSourceListViewController new];
    CYTNavigationController * carSourceNav = [[CYTNavigationController alloc] initWithRootViewController:carSourceCtr];
    
    //寻车
    CYTFindCarListViewController *findCarCtr = [CYTFindCarListViewController new];
    CYTNavigationController *findCarNav = [[CYTNavigationController alloc] initWithRootViewController:findCarCtr];
    
    //车商圈
    UIEdgeInsets inset = UIEdgeInsetsMake(CYTViewOriginY, 0, CYTTabBarHeight, 0);
    CYTCarTradeCircleCtr *carBCircleCtr = [[CYTCarTradeCircleCtr alloc] initWithViewModel:NSStringFromUIEdgeInsets(inset)];
    self.carFriendsCtr = carBCircleCtr;
    carBCircleCtr.requestURL = kURL.kURL_carFriends_home;
    carBCircleCtr.type =  CarTradeViewTypeHome;
    CYTNavigationController *carBCircleNav = [[CYTNavigationController alloc] initWithRootViewController:carBCircleCtr];
    
    //我
    CYTPersonalHome *meCtr = [CYTPersonalHome new];
    meCtr.title = titleArray[4];
    CYTNavigationController *meNav = [[CYTNavigationController alloc] initWithRootViewController:meCtr];
    
    
    self.viewControllers = @[homeNav,carSourceNav,findCarNav,carBCircleNav,meNav];
    
}

- (void)tabBarItemTitles:(NSArray *)tabBarItemTitles tabBarItemImages:(NSArray *)tabBarItemImages{
    NSArray *items = [[self tabBar] items];
    for (int i=0; i<items.count; i++) {
        UITabBarItem *item = items[i];
        NSString *selectImageName = [NSString stringWithFormat:@"%@press",[tabBarItemImages objectAtIndex:i]];
        UIImage *selectImage = [[UIImage imageNamed:selectImageName] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal];
        NSString *imageName = [NSString stringWithFormat:@"%@nor",[tabBarItemImages objectAtIndex:i]];
        UIImage *image = [UIImage imageNamed:imageName];
        NSString *title = tabBarItemTitles[i];
        
        item.title = title;
        item.image = image;
        item.selectedImage = selectImage;
    }
}

#pragma mark- get

- (CYTPrestrainManager *)prestrainManager {
    if (!_prestrainManager) {
        _prestrainManager = [CYTPrestrainManager new];
    }
    return _prestrainManager;
}

@end
