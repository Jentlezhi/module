//
//  CYTOldHomeViewController.m
//  CYTEasyPass
//
//  Created by xujunquan on 17/2/27.
//  Copyright © 2017年 EasyPass. All rights reserved.
//

#import "CYTH5WithInteractiveCtr.h"
#import "CYTLoginViewController.h"
#import "CYTLinkHandler.h"

///帮助
#define kHelpURL            @"CustomerService"
///拨打客服电话
#define kcallServiceUrl     @"callServiceUrl"
///立即注册
#define kregisterUrl        @"registerUrl"
///去认证
#define kuserAuthUrl        @"userAuthUrl"
///过期
#define kExpired            @"redirect_to_expired"

@interface CYTH5WithInteractiveCtr ()

@end

@implementation CYTH5WithInteractiveCtr

- (void)viewDidLoad {
    [super viewDidLoad];
}

- (void)backButtonClick:(UIButton *)backButton {
    if (self.webView.canGoBack) {
        [self.webView goBack];
    }else{
        [self.navigationController popViewControllerAnimated:YES];
    }
}

- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType{
    return [self handleURL:request.URL];
}

- (void)webViewDidFinishLoad:(UIWebView *)webView {
    NSString *htmlTitle = @"document.title";
    NSString *titleString = [webView stringByEvaluatingJavaScriptFromString:htmlTitle];
    self.navTitle = titleString;
}

- (BOOL)handleURL:(NSURL *)urlString {
    
    if ([urlString.scheme isEqualToString:@"cxt"]) {
        //cxy跳转处理
        //取反!!
        return ![[CYTLinkHandler new] handleAPPInnerLinkWithURL:urlString.absoluteString];
    }else {
        //其他http跳转
        if (urlString.absoluteString && [urlString.absoluteString rangeOfString:kExpired].location != NSNotFound ) {
            //弹出登录页面
            [CYTTools existLoginStateWithMessage:nil];
            return NO;
        }else {
            NSArray *pathArray = [urlString pathComponents];
            if ([pathArray containsObject:kHelpURL]) {
                [self goHelp];
                return NO;
            }else if ([pathArray containsObject:kcallServiceUrl]) {
                [self makePhone];
                return NO;
            }else if ([pathArray containsObject:kregisterUrl]) {
                [self registerMethod];
                return NO;
            }else if ([pathArray containsObject:kuserAuthUrl]) {
                [self authenticateMethod];
                return NO;
            }else {
                //其他的http链接不拦截。
                return YES;
            }
        }
    }
}

- (NSArray *)getParameters:(NSString *)queryString {
    NSArray *groupArray = [queryString componentsSeparatedByString:@"&"];
    NSMutableArray *mulArray = [NSMutableArray array];
    for (int i = 0; i<groupArray.count; i++) {
        NSString *itemString  = groupArray[i];
        NSArray *itemArray = [itemString componentsSeparatedByString:@"="];
        NSDictionary *itemDic = @{@"key":itemArray[0],
                                  @"value":itemArray[1]};
        [mulArray addObject:itemDic];
    }
    return mulArray;
}

#pragma mark- method

- (void)registerMethod {
    [[CYTAuthManager manager] goLoginView];
}

- (void)authenticateMethod {
    [[CYTAuthManager manager] goAuthenticateView];
}

- (void)makePhone {
    [self alert_service];
}

- (void)alert_service {
    [CYTPhoneCallHandler makeServicePhone];
}

#pragma mark- method
- (void)goHelp {
    CYTH5WithInteractiveCtr *ctr = [[CYTH5WithInteractiveCtr alloc] init];
    ctr.requestURL = kURL.kURL_Home_help;
    [self.navigationController pushViewController:ctr animated:YES];
}

@end
