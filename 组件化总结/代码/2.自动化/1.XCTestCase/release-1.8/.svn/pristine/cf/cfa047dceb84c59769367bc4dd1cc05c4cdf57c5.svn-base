//
//  CYTBrandSelect_cars.m
//  CYTEasyPass
//
//  Created by xujunquan on 17/9/4.
//  Copyright © 2017年 EasyPass. All rights reserved.
//

#import "CYTBrandSelect_cars.h"
#import "CYTBrandSelect_carCell.h"
#import "CYTBrandSelect_customCars.h"
#import "CYTBrandSelectCarGroupModel.h"

@interface CYTBrandSelect_cars ()<UITableViewDelegate,UITableViewDataSource,FFMainViewDelegate>
@property (nonatomic, strong) FFMainView *mainView;
@property (nonatomic, strong) UILabel *titleLabel;
@property (nonatomic, strong) UIButton *customCarButton;
///lastSelectCell
@property (nonatomic, strong) CYTBrandSelect_carCell *lastSelectCell;

@end

@implementation CYTBrandSelect_cars

- (void)viewDidLoad {
    [super viewDidLoad];
    [self createNavBarWithBackButtonAndTitle:@""];
    [self bindViewModel];
    [self loadUI];
    [self.mainView autoRefreshWithInterval:0 andPullRefresh:NO];
}

- (void)loadUI {
    [self.navigationBar addSubview:self.customCarButton];
    [self.navigationBar addSubview:self.titleLabel];
    [self.view addSubview:self.mainView];
    
    [self.customCarButton makeConstraints:^(MASConstraintMaker *make) {
        make.top.bottom.equalTo(self.navigationBar);
        make.right.equalTo(-CYTItemMarginH);
    }];
    
    NSString *title = [NSString stringWithFormat:@"%@ %@",self.viewModel.brandName,self.viewModel.seriesName];
    self.titleLabel.text = title;
    [self.titleLabel makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.equalTo(0);
        make.top.bottom.equalTo(self.navigationBar);
        make.right.lessThanOrEqualTo(self.customCarButton.left).offset(-5);
    }];
    
    [self.mainView makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.bottom.equalTo(self.view);
        make.top.equalTo(CYTViewOriginY);
    }];
}

- (void)bindViewModel {
    @weakify(self);
    
    [self.viewModel.hudSubject subscribeNext:^(id x) {
        if ([x integerValue]==0) {
            [CYTLoadingView showLoadingWithType:CYTLoadingViewTypeEditNavBar];
        }else {
            [CYTLoadingView hideLoadingView];
        }
    }];
    
    [self.viewModel.requestCommand.executionSignals.switchToLatest subscribeNext:^(FFBasicNetworkResponseModel *responseModel) {
        @strongify(self);
        
        [self.mainView autoReloadWithInterval:0 andMainViewModelBlock:^FFMainViewModel *{
            FFMainViewModel *model = [FFMainViewModel new];
            model.dataEmpty = self.viewModel.listArray.count == 0;
            model.dataHasMore = NO;
            model.netEffective = responseModel.resultEffective;
            return model;
        }];
    }];
}

#pragma mark- delegate
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
    return self.viewModel.listArray.count;
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section {
    UIView *header = [UIView new];
    header.backgroundColor = kColor_nor_back;
    UILabel *titleLabel = [UILabel labelWithFontPxSize:24 textColor:kContentMainColor];
    CYTBrandSelectCarGroupModel *group = self.viewModel.listArray[section];
    titleLabel.text = group.groupName;
    [header addSubview:titleLabel];
    [titleLabel makeConstraints:^(MASConstraintMaker *make) {
        make.top.bottom.right.equalTo(header);
        make.left.equalTo(CYTMarginH);
    }];
    return header;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section {
    return CYTAutoLayoutV(40);
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    CYTBrandSelectCarGroupModel *group = self.viewModel.listArray[section];
    return group.cars.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    CYTBrandSelect_carCell *cell = [tableView dequeueReusableCellWithIdentifier:[CYTBrandSelect_carCell identifier] forIndexPath:indexPath];
    CYTBrandSelectCarGroupModel *group = self.viewModel.listArray[indexPath.section];
    CYTBrandSelectCarModel *model = group.cars[indexPath.row];
    cell.contentLabel.text = model.carName;
    NSString *price = model.carReferPrice;
    if ([price isEqualToString:@"0"] || [price isEqualToString:@""]) {
        price = @"";
    }else {
        price = [NSString stringWithFormat:@"%@万元",price];
    }
    cell.assistantLabel.text = price;
    cell.highlightedCell = (model.carId == self.viewModel.lastCarId);
    if (model.carId == self.viewModel.lastCarId) {
        self.lastSelectCell = cell;
    }
    
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    CYTBrandSelectCarGroupModel *group = self.viewModel.listArray[indexPath.section];
    CYTBrandSelectCarModel *model = group.cars[indexPath.row];
    //高亮
    if (self.lastSelectCell) {
        self.lastSelectCell.highlightedCell = NO;
    }
    CYTBrandSelect_carCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    cell.highlightedCell = YES;
    self.lastSelectCell = cell;
    
    //拼接年款
    model.carName = [NSString stringWithFormat:@"%@%@",group.groupName,model.carName];
    if (self.carBlock) {
        self.carBlock(model);
    }
}

- (void)mainViewWillRefresh:(FFMainView *)mainView {
    [self.viewModel.requestCommand execute:nil];
}

- (void)mainViewWillReload:(FFMainView *)mainView {
    [self.viewModel.requestCommand execute:nil];
}

#pragma mark- get
- (FFMainView *)mainView {
    if (!_mainView) {
        _mainView = [FFMainView new];
        _mainView.delegate = self;
        [CYTTools configForMainView:_mainView ];
        _mainView.mjrefreshSupport = MJRefreshSupportNone;
        [_mainView registerCellWithIdentifier:@[[CYTBrandSelect_carCell identifier]]];
    }
    return _mainView;
}

- (CYTBrandSelect_carVM *)viewModel {
    if (!_viewModel) {
        _viewModel = [CYTBrandSelect_carVM new];
    }
    return _viewModel;
}

- (UILabel *)titleLabel {
    if (!_titleLabel) {
        _titleLabel = [UILabel labelWithFontPxSize:34 textColor:kTitleMainColor];
        [_titleLabel setContentCompressionResistancePriority:UILayoutPriorityDefaultLow forAxis:UILayoutConstraintAxisHorizontal];
        _titleLabel.textAlignment = NSTextAlignmentCenter;
    }
    return _titleLabel;
}

- (UIButton *)customCarButton {
    if (!_customCarButton) {
        _customCarButton = [UIButton buttonWithType:UIButtonTypeCustom];
        @weakify(self);
        [[_customCarButton rac_signalForControlEvents:UIControlEventTouchUpInside] subscribeNext:^(id x) {
            @strongify(self);
            CYTBrandSelect_customCars *customCar = [CYTBrandSelect_customCars new];
            customCar.titleName = [NSString stringWithFormat:@"%@ %@",self.viewModel.brandName,self.viewModel.seriesName];
            
            [customCar setStringBlock:^(NSString *string) {
                //自定义车款名称
                CYTBrandSelectCarModel *model = [CYTBrandSelectCarModel new];
                model.carName = string;
                model.carId = -1;
                model.carReferPrice = @"0";
                model.isParallelImportCar = self.viewModel.isParallelImportCar;
                model.type = self.viewModel.type;
                model.typeName = self.viewModel.typeName;
                if (self.carBlock) {
                    self.carBlock(model);
                }
            }];
            [self.navigationController pushViewController:customCar animated:YES];
        }];
        
        [_customCarButton setTitle:@"自定义车型" forState:UIControlStateNormal];
        [_customCarButton setTitleColor:kColor_666666 forState:UIControlStateNormal];
        _customCarButton.titleLabel.font = [UIFont systemFontOfSize:14];
        
    }
    return _customCarButton;
}

@end
