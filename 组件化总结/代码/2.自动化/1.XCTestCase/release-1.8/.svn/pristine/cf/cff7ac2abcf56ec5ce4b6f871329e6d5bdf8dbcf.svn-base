//
//  CYTPriceInputToolBar.m
//  CYTEasyPass
//
//  Created by xujunquan on 17/6/12.
//  Copyright © 2017年 EasyPass. All rights reserved.
//

#import "CYTPriceInputToolBar.h"

@interface CYTPriceInputToolBar()
@property (nonatomic, weak) UIView *supView;
@property (nonatomic, strong) UIView *bgView;

@end

@implementation CYTPriceInputToolBar

- (instancetype)init{
    if (self = [super init]) {
         UIBarButtonItem *fixedLeft = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFixedSpace target:nil action:nil];
         fixedLeft.width = -16.0f;
         self = [[CYTPriceInputToolBar alloc] initWithFrame:CGRectMake(0, 0, kScreenWidth, kInputViewHeight)];
         self.barStyle = UIBarStyleDefault;
         UIBarButtonItem *item = [[UIBarButtonItem alloc] initWithCustomView:self.inputView];
         [self setItems:@[fixedLeft,item]];
        
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillShow:) name:UIKeyboardWillShowNotification object:nil];
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillHide:) name:UIKeyboardWillHideNotification object:nil];
    }
    return self;
}

- (float)viewHeight {
    return kInputViewHeight;
}

- (void)showOnView:(UIView *)view {
    self.supView = view;
    
    [self.supView addSubview:self.bgView];
    [self.supView addSubview:self];
    
    [self.bgView makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.supView);
    }];
    [self makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.equalTo(self.supView);
        make.height.equalTo(kInputViewHeight);
        make.bottom.equalTo(self.supView).offset(kInputViewHeight);
    }];
    [self layoutIfNeeded];
}

- (void)setEffective:(BOOL)effective {
    _effective = effective;
    
    if (effective) {
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [self.inputView.contentView.textFiled becomeFirstResponder];
        });
    }
}

- (void)setGuidePrice:(NSString *)guidePrice {
    _guidePrice = guidePrice;
    self.inputView.guidePrice = guidePrice;
}

#pragma mark - 键盘处理
- (void)keyboardWillShow:(NSNotification *)note {
    if (!self.effective) {
        return;
    }
    dispatch_async(dispatch_get_main_queue(), ^{
        // 取出键盘最终的frame
        CGRect rect = [note.userInfo[UIKeyboardFrameEndUserInfoKey] CGRectValue];
        // 取出键盘弹出需要花费的时间
        double duration = [note.userInfo[UIKeyboardAnimationDurationUserInfoKey] doubleValue];
        // 修改约束
        [self updateConstraints:^(MASConstraintMaker *make) {
            make.bottom.equalTo(self.supView).offset(-rect.size.height);
        }];
        [UIView animateWithDuration:duration animations:^{
            [self.supView layoutIfNeeded];
            self.bgView.alpha = 1;
        }];
    });
}

- (void)keyboardWillHide:(NSNotification *)note {
    if (!self.effective) {
        return;
    }
    [self hideSelf];
}

- (void)hideSelf {
    dispatch_async(dispatch_get_main_queue(), ^{
        // 取出键盘弹出需要花费的时间
        double duration = 0.2;
        // 修改约束
        [self updateConstraints:^(MASConstraintMaker *make) {
            make.bottom.equalTo(self.supView.bottom).offset(kInputViewHeight);
        }];
        [UIView animateWithDuration:duration animations:^{
            [self.supView layoutIfNeeded];
            self.bgView.alpha = 0;
        }];
    });
    
    [self.inputView.contentView.textFiled resignFirstResponder];
    [self.inputView.contentView clearMethod];
}

#pragma mark- get
- (CYTPriceInputView *)inputView {
    if (!_inputView) {
        _inputView = [[CYTPriceInputView alloc] initWithFrame:CGRectMake(0, 0, kScreenWidth, kInputViewHeight)];
        
        @weakify(self);
        [_inputView setCancelBlock:^{
            @strongify(self);
            [self hideSelf];
            if (self.cancelBlock) {
                self.cancelBlock();
            }
        }];
        
        [_inputView setAffirmBlock:^(NSInteger index, NSString *value, NSString *resultPrice) {
            @strongify(self);
            if (index == 3 && ([value isEqualToString:@""] || [value floatValue] == 0)) {
                [CYTToast messageToastWithMessage:@"报价不能为空"];
//                return ;
            }
            [self hideSelf];
            if (self.affirmBlock) {
                self.affirmBlock(index,value,resultPrice);
            }
        }];
    }
    return _inputView;
}

- (UIView *)bgView {
    if (!_bgView) {
        _bgView = [UIView new];
        _bgView.backgroundColor = [[UIColor blackColor] colorWithAlphaComponent:0.3];
        UITapGestureRecognizer *tapGes = [UITapGestureRecognizer new];
        _bgView.alpha = 0;
        @weakify(self);
        [[tapGes rac_gestureSignal] subscribeNext:^(id x) {
            @strongify(self);
            
            [self hideSelf];
            if (self.cancelBlock) {
                self.cancelBlock();
            }
        }];
        [_bgView addGestureRecognizer:tapGes];
    }
    return _bgView;
}

- (void)dealloc {
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

@end
