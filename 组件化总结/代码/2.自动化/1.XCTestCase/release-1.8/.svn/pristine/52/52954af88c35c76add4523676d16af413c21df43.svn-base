//
//  CYTGetColorBasicViewController.m
//  CYTEasyPass
//
//  Created by xujunquan on 17/6/1.
//  Copyright © 2017年 EasyPass. All rights reserved.
//

#import "CYTGetColorBasicViewController.h"
#import "CYTGetColorConst.h"
#import "CYTColorInputViewController.h"

@interface CYTGetColorBasicViewController ()<UITableViewDelegate,UITableViewDataSource>
///自定义颜色
@property (nonatomic, strong) UIButton *rightButton;
@property (nonatomic, strong) CYTGetColorBasicCell *lastCell;

@end

@implementation CYTGetColorBasicViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self loadUI];
}

- (void)loadUI {
    NSString *title = (self.inColor)?@"内饰颜色":@"外观颜色";
    [self createNavBarWithBackButtonAndTitle:title];
    
    [self.view addSubview:self.tableView];
    [self.tableView makeConstraints:^(MASConstraintMaker *make) {
        make.left.bottom.right.equalTo(self.view);
        make.top.equalTo(CYTViewOriginY);
    }];
    
    [self.view addSubview:self.rightButton];
    [self.rightButton makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(CYTStatusBarHeight);
        make.right.equalTo(-10);
        make.height.equalTo(44);
    }];
}

- (void)rightButtonClick:(UIButton *)rightButton {
    CYTColorInputViewController *input = [CYTColorInputViewController new];
    input.viewModel = self.viewModel;
    input.inColor = self.inColor;
    [self.navigationController pushViewController:input animated:YES];
}

#pragma mark- delegate
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    NSArray *tmp = (self.inColor)?self.viewModel.inColorArray:self.viewModel.exColorArray;
    return tmp.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    NSString *itemColor = (self.inColor)?self.viewModel.inColorArray[indexPath.row]:self.viewModel.exColorArray[indexPath.row];
    NSString *selectColor = (self.inColor)?self.viewModel.inColorSel:self.viewModel.exColorSel;
    
    CYTGetColorBasicCell *cell = [tableView dequeueReusableCellWithIdentifier:[CYTGetColorBasicCell identifier] forIndexPath:indexPath];
    cell.titleLab.text = itemColor;
    
    if (selectColor && [itemColor isEqualToString:selectColor]) {
        cell.titleLab.textColor = kGreenNormal;
    }else {
        cell.titleLab.textColor = kTitleMainColor;
    }
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    //改变颜色
    CYTGetColorBasicCell *cell = [tableView dequeueReusableCellWithIdentifier:[CYTGetColorBasicCell identifier] forIndexPath:indexPath];
    cell.titleLab.textColor = kGreenNormal;
    
    if (self.lastCell) {
        self.lastCell.titleLab.textColor = kTitleMainColor;
    }
    
    self.lastCell = cell;
    
    NSString *color = (self.inColor)?self.viewModel.inColorArray[indexPath.row]:self.viewModel.exColorArray[indexPath.row];
    if (self.inColor) {
        self.viewModel.inColorSel = color;
    }else {
        self.viewModel.exColorSel = color;
    }
    [self.tableView reloadData];
    [self selectColorWithModel:color];
}

- (void)selectColorWithModel:(NSString *)color {
    if (!self.inColor) {
        //当前是外观选择，点击进入内饰选择
        CYTGetColorBasicViewController *inColorCtr = [CYTGetColorBasicViewController new];
        inColorCtr.viewModel = self.viewModel;
        inColorCtr.inColor = YES;
        
        [self.navigationController pushViewController:inColorCtr animated:YES];
    }else {
        //当前是内饰选择，点击选择颜色，则操作完成
        [[NSNotificationCenter defaultCenter] postNotificationName:kGetColorFinished object:nil];
    }
}

#pragma mark- get
- (UITableView *)tableView {
    if (!_tableView) {
        _tableView = [UITableView new];
        if (@available(iOS 11.0, *)) {
            _tableView.contentInsetAdjustmentBehavior = UIScrollViewContentInsetAdjustmentNever;
            _tableView.estimatedSectionFooterHeight = 0;
            _tableView.estimatedSectionHeaderHeight = 0;
        }
        _tableView.delegate = self;
        _tableView.dataSource = self;
        _tableView.rowHeight = UITableViewAutomaticDimension;
        _tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
        _tableView.estimatedRowHeight = 50;
        [_tableView registerClass:[CYTGetColorBasicCell class] forCellReuseIdentifier:[CYTGetColorBasicCell identifier]];
        _tableView.contentInset = UIEdgeInsetsMake(10, 0, 0, 0);
        _tableView.bgColor = kColor_nor_back;
    }
    return _tableView;
}

- (UIButton *)rightButton {
    if (!_rightButton) {
        _rightButton = [UIButton buttonWithFontPxSize:28 textColor:kColor_666666 text:@"自定义颜色"];
        @weakify(self);
        [[_rightButton rac_signalForControlEvents:UIControlEventTouchUpInside] subscribeNext:^(id x) {
            @strongify(self);
            
            CYTColorInputViewController *input = [CYTColorInputViewController new];
            input.viewModel = self.viewModel;
            input.inColor = self.inColor;
            [self.navigationController pushViewController:input animated:YES];
        }];
    }
    return _rightButton;
}

- (CYTGetColorBasicVM *)viewModel {
    if (!_viewModel) {
        _viewModel = [CYTGetColorBasicVM new];
    }
    return _viewModel;
}

@end
