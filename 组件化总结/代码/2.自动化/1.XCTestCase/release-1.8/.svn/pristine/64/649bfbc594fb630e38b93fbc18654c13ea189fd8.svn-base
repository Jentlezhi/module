//
//  CYTHomeDataViewModel.m
//  CYTEasyPass
//
//  Created by Jentle on 2017/10/16.
//  Copyright © 2017年 EasyPass. All rights reserved.
//

#import "CYTHomeDataViewModel.h"
#import "CYTBannerInfoModel.h"
#import "CYTFunctionModel.h"
#import "CYTHomeCarSourceInfoModel.h"
#import "CYTStoreAuthModel.h"

@interface CYTHomeDataViewModel()

/** 特价车源 */
@property(strong, nonatomic) NSMutableDictionary *getRecommendCarSourceListPar;
/** 靠谱车商数据模型 */
@property(strong, nonatomic) CYTRootResponseModel *storeAuthListtResponseModel;
/** 平行进口车广告数据模型 */
@property(strong, nonatomic) CYTRootResponseModel *recommendResponseModel;
/** 特价车源数据模型 */
@property(strong, nonatomic) CYTRootResponseModel *carSourceListRootResponseModel;
///** 靠谱车商数据请求信号 */
@property(strong, nonatomic) RACSignal *storeAuthListSignal;
/** 平行进口车广告数据请求信号 */
@property(strong, nonatomic) RACSignal *recommendListSignal;
/** 特价车源数据请求信号 */
@property(strong, nonatomic) RACSignal *recommendCarSourceListSignal;

@end

@implementation CYTHomeDataViewModel


- (instancetype)init{
    if (self = [super init]) {
        [self homeDataBasicConfig];
    }
    return self;
}

- (void)homeDataBasicConfig{
    _getBannerInfoCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(id input) {
        return [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
            [CYTNetworkManager GET:kURL.basic_index_getBannerInfo parameters:nil dataTask:nil showErrorTost:NO completion:^(CYTNetworkResponse *responseObject) {
                NSArray *list = [responseObject.dataDictionary valueForKey:@"list"];
                NSArray *bannerInfoModels = [CYTBannerInfoModel mj_objectArrayWithKeyValuesArray:list];
                [subscriber sendNext:bannerInfoModels];
                [subscriber sendCompleted];
            }];
            return nil;
        }];
        
    }];
    
    _getUnreadCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(id input) {
        return [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
            [CYTNetworkManager GET:kURL.message_center_getUnread parameters:nil dataTask:nil showErrorTost:NO completion:^(CYTNetworkResponse *responseObject) {
                [subscriber sendNext:responseObject];
                [subscriber sendCompleted];
            }];
            return nil;
        }];
    }];
    
    _getIndexFunctionCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(id input) {
        return [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
            [CYTNetworkManager GET:kURL.basic_index_getIndexFunctionButtons parameters:nil dataTask:nil showErrorTost:NO completion:^(CYTNetworkResponse *responseObject) {
                NSArray *list = [responseObject.dataDictionary valueForKey:@"list"];
                NSArray *functionModels = [CYTFunctionModel mj_objectArrayWithKeyValuesArray:list];
                [subscriber sendNext:functionModels];
                [subscriber sendCompleted];
            }];
            return nil;
        }];
    }];
    
    _getRecommendListCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(id input) {
        return [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
            [self requestCarSourceListDataWithSubscriber:subscriber];
            return nil;
        }];
    }];

}
- (void)requestOtherData{
    RACSignal *storeAuthListSignal = [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        [CYTNetworkManager GET:kURL.basic_index_getIndexStoreAuthList parameters:nil dataTask:nil showErrorTost:NO completion:^(CYTNetworkResponse *responseObject) {
            self.storeAuthListtResponseModel.networkError = !responseObject.resultEffective;
            NSArray *list = [responseObject.dataDictionary valueForKey:@"list"];
            NSArray *storeAuthModels = [CYTStoreAuthModel mj_objectArrayWithKeyValuesArray:list];
            if (storeAuthModels.count) {
                self.storeAuthListtResponseModel.arrayData = storeAuthModels;
            }
            [subscriber sendNext:self.storeAuthListtResponseModel];
            [subscriber sendCompleted];
        }];
        return nil;
    }];
    
    RACSignal *recommendListSignal = [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        [CYTNetworkManager GET:kURL.basic_index_getIndexRecommendList parameters:nil dataTask:nil showErrorTost:NO completion:^(CYTNetworkResponse *responseObject) {
            self.recommendResponseModel.networkError = !responseObject.resultEffective;
            NSArray *list = [responseObject.dataDictionary valueForKey:@"list"];
            NSArray *recommendLists = [CYTFunctionModel mj_objectArrayWithKeyValuesArray:list];
            if (recommendLists.count) {
                self.recommendResponseModel.arrayData = recommendLists;
            }
            [subscriber sendNext:self.recommendResponseModel];
            [subscriber sendCompleted];
        }];
        return nil;
    }];
    
    RACSignal *recommendCarSourceListSignal = [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        [self requestCarSourceListDataWithSubscriber:subscriber];
        return nil;
    }];
    
    [self rac_liftSelector:@selector(finishRequestWithStoreAuthListData:recommendListData:carSourceListData:) withSignalsFromArray:@[storeAuthListSignal,recommendListSignal,recommendCarSourceListSignal]];
}

- (void)requestCarSourceListDataWithSubscriber:(id<RACSubscriber>)subscriber{
    if (self.requestType == CYTRequestTypeRefresh) {
        [self.getRecommendCarSourceListPar setValue:@"-1" forKey:@"lastId"];
    }
    [CYTNetworkManager GET:kURL.car_source_getRecommendCarSourceList parameters:self.getRecommendCarSourceListPar dataTask:nil showErrorTost:NO completion:^(CYTNetworkResponse *responseObject) {
        self.carSourceListRootResponseModel.networkError = !responseObject.resultEffective;
        if (responseObject.resultEffective) {
            if (self.requestType == CYTRequestTypeRefresh) {
                [self.carSourceListRootResponseModel.arrayData removeAllObjects];
            }
            NSArray *list = [responseObject.dataDictionary valueForKey:@"list"];
            self.carSourceListRootResponseModel.isMore = [[responseObject.dataDictionary valueForKey:@"isMore"] boolValue];
            NSMutableArray *keyValursArray = [NSMutableArray array];
            [list enumerateObjectsUsingBlock:^(NSDictionary  *obj, NSUInteger idx, BOOL * _Nonnull stop) {
                [keyValursArray addObject:[obj valueForKey:@"carSourceInfo"]];
            }];
            NSArray *modelsArray = [CYTHomeCarSourceInfoModel mj_objectArrayWithKeyValuesArray:keyValursArray];
            [self.carSourceListRootResponseModel.arrayData addObjectsFromArray:modelsArray];
            self.carSourceListRootResponseModel.nodata = !self.carSourceListRootResponseModel.arrayData.count;
            CYTHomeCarSourceInfoModel *homeCarSourceInfoModel = [self.carSourceListRootResponseModel.arrayData lastObject];
            [self.getRecommendCarSourceListPar setValue:homeCarSourceInfoModel.rowId forKey:@"lastId"];
        }else{
            self.carSourceListRootResponseModel.isMore = NO;
            if (self.requestType == CYTRequestTypeLoadMore) {
                [CYTToast errorToastWithMessage:CYTNetworkError];
            }
        }
        [subscriber sendNext:self.carSourceListRootResponseModel];
        [subscriber sendCompleted];
    }];
}

- (void)finishRequestWithStoreAuthListData:(CYTRootResponseModel *)storeAuthListData recommendListData:(CYTRootResponseModel *)recommendListData carSourceListData:(CYTRootResponseModel *)carSourceListDataData{
    !self.finishRequestData?:self.finishRequestData(storeAuthListData,recommendListData,carSourceListDataData);
}
- (CYTRootResponseModel *)storeAuthListtResponseModel{
    if (!_storeAuthListtResponseModel) {
        _storeAuthListtResponseModel = [CYTRootResponseModel new];
    }
    return _storeAuthListtResponseModel;
}

- (CYTRootResponseModel *)recommendResponseModel{
    if (!_recommendResponseModel) {
        _recommendResponseModel = [CYTRootResponseModel new];
    }
    return _recommendResponseModel;
}
- (CYTRootResponseModel *)carSourceListRootResponseModel{
    if (!_carSourceListRootResponseModel) {
        _carSourceListRootResponseModel = [CYTRootResponseModel new];
    }
    return _carSourceListRootResponseModel;
}

- (NSMutableDictionary *)getRecommendCarSourceListPar{
    if (!_getRecommendCarSourceListPar) {
        _getRecommendCarSourceListPar = [NSMutableDictionary dictionary];
    }
    return _getRecommendCarSourceListPar;
}

@end
