//
//  CarFilterController.m
//  CYTEasyPass
//
//  Created by xujunquan on 2017/10/11.
//  Copyright © 2017年 EasyPass. All rights reserved.
//

#import "CarFilterController.h"
#import "CarFilterConditionView.h"
#import "CYTCarListInfoCell.h"
#import "CYTCarSourceDetailVC.h"
#import "CYTCarSourceListModel.h"
#import "CYTSeekCarListModel.h"
#import "CYTSeekCarDetailViewController.h"

@interface CarFilterController ()<UITableViewDelegate,UITableViewDataSource,FFMainViewDelegate>
@property (nonatomic, strong) CarFilterConditionView *conditionView;
@property (nonatomic, strong) FFMainView *mainView;
@property (nonatomic, strong) UIView *bgView;

@end

@implementation CarFilterController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self createNavBarWithBackButtonAndTitle:self.viewModel.titleString];
    [self bindViewModel];
    [self loadUI];
    [self.mainView autoRefreshWithInterval:0 andPullRefresh:YES];
    @weakify(self);
    [[[NSNotificationCenter defaultCenter] rac_addObserverForName:kCarFilterRefreshKey object:nil] subscribeNext:^(id x) {
        @strongify(self);
        [self.mainView autoRefreshWithInterval:0 andPullRefresh:YES];
    }];
}

- (void)loadUI {
    [self.view addSubview:self.mainView];
    [self.view addSubview:self.bgView];
    [self.view addSubview:self.conditionView];
    [self.mainView makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.bottom.equalTo(self.view);
        make.top.equalTo(CYTViewOriginY+CYTAutoLayoutV(80));
    }];
    [self.conditionView makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.equalTo(self.view);
        make.top.equalTo(CYTViewOriginY);
        make.height.equalTo(CYTAutoLayoutV(80));
    }];
    [self.bgView makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.bottom.equalTo(self.view);
        make.top.equalTo(CYTViewOriginY);
    }];
}

- (void)bindViewModel {
    @weakify(self);
    
    //满足筛选条件的数据
    [self.viewModel.requestCommand.executionSignals.switchToLatest subscribeNext:^(FFBasicNetworkResponseModel *responseModel) {
        @strongify(self);
        [self.mainView autoReloadWithInterval:0 andMainViewModelBlock:^FFMainViewModel *{
            FFMainViewModel *model = [FFMainViewModel new];
            model.dataEmpty = (self.viewModel.listArray.count==0);
            model.dataHasMore = self.viewModel.isMore;
            model.netEffective = responseModel.resultEffective;
            return model;
        }];
    }];
}

#pragma mark- delegate
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return self.viewModel.listArray.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    CYTCarListInfoCell *cell = [CYTCarListInfoCell cellWithType:CYTCarListInfoTypeCarSource forTableView:self.mainView.tableView indexPath:indexPath hideTopBar:NO];
    if (self.viewModel.source == CarViewSourceCarSource) {
        cell.carSourceListModel = self.viewModel.listArray[indexPath.row];
    }else {
        cell.seekCarListModel = self.viewModel.listArray[indexPath.row];
    }
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    if (self.viewModel.source == CarViewSourceCarSource) {
        CYTCarSourceListModel *model = self.viewModel.listArray[indexPath.row];
        CYTCarSourceDetailVC *detail = [CYTCarSourceDetailVC new];
        detail.viewModel.carSourceId = model.carSourceInfo.carSourceId;
        [self.navigationController pushViewController:detail animated:YES];
    }else {
        CYTSeekCarListModel *model = self.viewModel.listArray[indexPath.row];
        CYTSeekCarDetailViewController *detail = [[CYTSeekCarDetailViewController alloc] init];
        detail.seekCarId = model.seekCarInfo.seekCarId;
        detail.userId = model.dealer.userId;
        [self.navigationController pushViewController:detail animated:YES];
    }
}

- (void)mainViewWillRefresh:(FFMainView *)mainView {
    self.viewModel.listRequestModel.lastId = 0;
    [self.viewModel.requestCommand execute:nil];
}

- (void)mainViewWillLoadMore:(FFMainView *)mainView {
    [self.viewModel.requestCommand execute:nil];
}

#pragma mark- get
- (CarFilterConditionView *)conditionView {
    if (!_conditionView) {
        CarFilterConditionVM *vm = [CarFilterConditionVM new];
        vm.requestModel = self.viewModel.requestModel;
        vm.listRequestModel = self.viewModel.listRequestModel;
        _conditionView = [[CarFilterConditionView alloc] initWithViewModel:vm];
        _conditionView.segmentHeight = CYTAutoLayoutV(80);
        @weakify(self);
        [_conditionView setConditionViewExtendBlock:^(BOOL isExtend) {
            @strongify(self);
            self.bgView.alpha = (isExtend)?1:0;
        }];
    }
    return _conditionView;
}

- (FFMainView *)mainView {
    if (!_mainView) {
        _mainView = [FFMainView new];
        _mainView.delegate = self;
        [CYTTools configForMainView:_mainView ];
        _mainView.dznCustomView.emptyView.dznLabel.text = @"- 暂无更多内容 -";
    }
    return _mainView;
}

- (CarFilterVM *)viewModel {
    if (!_viewModel) {
        _viewModel = [CarFilterVM new];
    }
    return _viewModel;
}

- (UIView *)bgView {
    if (!_bgView) {
        _bgView = [UIView new];
        _bgView.backgroundColor = [[UIColor blackColor] colorWithAlphaComponent:0.4];
        _bgView.alpha = 0;
    }
    return _bgView;
}

@end
