//
//  CYTLogisticsNeedWriteCtr.m
//  CYTEasyPass
//
//  Created by xujunquan on 17/5/11.
//  Copyright © 2017年 EasyPass. All rights reserved.
//

#import "CYTLogisticsNeedWriteCtr.h"
#import "CYTLogisticsNeedBottomView.h"
#import "FFCell_Style_SimpleChoose.h"
#import "FFCell_Style_Input.h"
#import "CYTLogisticsNeedServiceCell.h"
#import "CYTLogisticsNeedAddressCell.h"
#import "CYTLogisticsProtocalView.h"
#import "CYTCarBrandModel.h"
#import "CYTAddressListViewController.h"
#import "CYTAddressChooseCommonVC.h"
#import "CYTBrandSelectViewController.h"
#import "CYTLogisticsNeedDetailCtr.h"

@interface CYTLogisticsNeedWriteCtr ()<UITableViewDelegate,UITableViewDataSource,FFMainViewDelegate>
@property (nonatomic, strong) FFMainView *mainView;
@property (nonatomic, strong) CYTLogisticsProtocalView *protocalView;
@property (nonatomic, strong) CYTLogisticsNeedBottomView *bottomView;
@property (nonatomic, strong) UITextField *textFiled;
@property (nonatomic, assign) NSInteger sectionNumber;

@end

@implementation CYTLogisticsNeedWriteCtr

- (instancetype)initWithViewModel:(id)viewModel {
    if (self = [super initWithViewModel:viewModel]) {
        _viewModel = viewModel;
    }
    return self;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.sectionNumber = 3;
    self.view.backgroundColor = kColor_nor_back;
    [self bindViewModel];
    [self loadUI];
    [self createNavBarWithTitle:@"物流需求提交" andShowBackButton:YES showRightButtonWithTitle:@"帮助"];
    
    [self.mainView autoRefreshWithInterval:0 andPullRefresh:NO];
    
    if (!self.viewModel.needGetLogisticInfo) {
        [self showTableView];
    }
}

- (void)bindViewModel {

    @weakify(self);
    [self.viewModel.hudSubject subscribeNext:^(id x) {
        if ([x integerValue]==0) {
            [CYTLoadingView showLoadingWithType:CYTLoadingViewTypeEditNavBar];
        }else {
            [CYTLoadingView hideLoadingView];
        }
    }];
    
    //提交需求结果
    [self.viewModel.requestCommand.executionSignals.switchToLatest subscribeNext:^(FFBasicNetworkResponseModel *responseModel) {
        @strongify(self);
        if (responseModel.resultEffective) {
            //发送消息，刷新需求列表
            [[NSNotificationCenter defaultCenter] postNotificationName:kLogisticsNeedListRefreshKey object:nil];
            
            UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示" message:responseModel.resultMessage delegate:nil cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
            @weakify(self);
            [[alert rac_buttonClickedSignal] subscribeNext:^(id x) {
                @strongify(self);
                CYTLogisticsNeedDetailCtr *detail = [CYTLogisticsNeedDetailCtr new];
                detail.viewModel.source = (self.viewModel.needGetLogisticInfo)?LogisticsDetailSourceCallTransport:LogisticsDetailSourcePublish;
                NSInteger demandId = [[responseModel.dataDictionary valueForKey:@"demandId"] integerValue];
                detail.viewModel.neeId = demandId;
                [self.navigationController pushViewController:detail animated:YES];
            }];
            [alert show];

        }else {
            if (responseModel.httpCode==4000001) {
                //报价问题
                UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示" message:responseModel.resultMessage delegate:nil cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
                [[alert rac_buttonClickedSignal] subscribeNext:^(id x) {
                    //none
                }];
                [alert show];
            }else {
                [CYTToast errorToastWithMessage:responseModel.resultMessage];
            }
        }
    }];
    
    //叫个物流获取物流携带信息结果
    [self.viewModel.requestLogisticInfo.executionSignals.switchToLatest subscribeNext:^(id x) {
        @strongify(self);
        if (self.viewModel.logisticInfoResult.resultEffective) {
            //成功更新UI
            [self showTableView];
            self.bottomView.valid = self.viewModel.valid;
        }else {
            //失败显示reload
            [self showReloadView];
        }
    }];
}

- (void)loadUI {
    [self.view addSubview:self.mainView];
    [self.view addSubview:self.protocalView];
    [self.view addSubview:self.bottomView];
    [self.mainView makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.equalTo(self.view);
        make.top.equalTo(CYTViewOriginY);
        make.bottom.equalTo(self.protocalView.top).offset(-CYTAutoLayoutV(20));
    }];
    [self.protocalView makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.equalTo(self.view);
        make.bottom.equalTo(self.bottomView.top).offset(-CYTAutoLayoutV(10));
    }];
    [self.bottomView makeConstraints:^(MASConstraintMaker *make) {
        make.bottom.equalTo(0);
        make.left.right.bottom.equalTo(self.view);
        make.height.equalTo(50);
    }];
}

- (void)backButtonClick:(UIButton *)backButton {
    [self.view endEditing:YES];
    [self.navigationController popViewControllerAnimated:YES];
}

- (void)rightButtonClick:(UIButton *)rightButton {
    [self gotoHelpView];
}

#pragma mark- table reload
- (void)showReloadView {
    self.protocalView.hidden = YES;
    self.bottomView.hidden = YES;
    self.sectionNumber = 0;
    
    [self.mainView remakeConstraints:^(MASConstraintMaker *make) {
        make.left.right.equalTo(self.view);
        make.top.equalTo(CYTViewOriginY);
        make.bottom.equalTo(0);
    }];
    
    [self.mainView autoReloadWithInterval:0 andMainViewModelBlock:^FFMainViewModel *{
        FFMainViewModel *model = [FFMainViewModel new];
        model.dataHasMore = NO;
        model.dataEmpty = YES;
        model.netEffective = NO;
        return model;
    }];
}

- (void)showTableView {
    self.protocalView.hidden = NO;
    self.bottomView.hidden = NO;
    self.sectionNumber = 3;
    
    [self.mainView remakeConstraints:^(MASConstraintMaker *make) {
        make.left.right.equalTo(self.view);
        make.top.equalTo(CYTViewOriginY);
        make.bottom.equalTo(self.protocalView.top).offset(-CYTAutoLayoutV(20));
    }];
    
    [self.mainView autoReloadWithInterval:0 andMainViewModelBlock:^FFMainViewModel *{
        FFMainViewModel *model = [FFMainViewModel new];
        model.dataHasMore = NO;
        model.dataEmpty = NO;
        model.netEffective = YES;
        return model;
    }];
}

#pragma mark- method
- (NSInteger)indexWithIndexPath:(NSIndexPath *)indexPath {
    if (indexPath.section==0) {
        return indexPath.row;
    }
    if (indexPath.section == 1) {
        return 2+indexPath.row;
    }
    if (indexPath.section == 2) {
        return 5+indexPath.row;
    }
    return 0;
}

- (void)changePrice:(NSString *)price {
    CYTLogisticsNeedWriteCellModel *model = self.viewModel.cellModelArray[4];
    if (price.length>0) {
        model.select = YES;
        model.contentString = price;
    }else {
        model.select = NO;
    }
    self.bottomView.valid = self.viewModel.valid;
}

- (void)gotoProtocalView {
    CYTH5WithInteractiveCtr *ctr = [[CYTH5WithInteractiveCtr alloc] init];
    ctr.requestURL = kURL.kURL_me_set_transport;
    [self.navigationController pushViewController:ctr animated:YES];
}

- (void)gotoHelpView {
    CYTH5WithInteractiveCtr *ctr = [[CYTH5WithInteractiveCtr alloc] init];
    ctr.requestURL = kURL.kURLLogistics_publishNeed_help;
    [self.navigationController pushViewController:ctr animated:YES];
}

- (void)handleCarNumber:(NSInteger)number {
    CYTLogisticsNeedWriteCellModel *model = self.viewModel.cellModelArray[3];
    model.select = YES;
    model.contentString = [NSString stringWithFormat:@"%ld",number];
    self.bottomView.valid = self.viewModel.valid;
}

#pragma mark- 选择地址
- (void)gotoAddressCtrWithIndex:(NSInteger)index {

    //根据index获取对应的数据模型
    CYTAddressDataWNCManager *addressManager = (self.viewModel.addressIndex==0)?self.viewModel.sendManager:self.viewModel.receiveManager;
    if (!addressManager) {
        addressManager =[CYTAddressDataWNCManager shareManager];
        [addressManager cleanAllModelCache];
        addressManager.showArea = NO;
        addressManager.titleString = @"城市选择";
        addressManager.type = AddressChooseTypeCounty;
    }
    
    CYTAddressChooseCommonVC *choose = [CYTAddressChooseCommonVC new];
    choose.viewModel = addressManager;
    [choose setChooseFinishedBlock:^(CYTAddressDataWNCManager *model) {
        //处理回调数据
        if (self.viewModel.addressIndex == 0) {
            self.viewModel.sendManager = model;
        }else {
            self.viewModel.receiveManager = model;
        }
        
        //数据处理
        CYTAddressModel *addressModel = [CYTAddressModel new];
        addressModel.provinceId = [NSString stringWithFormat:@"%ld",(long)model.addressModel.selectProvinceModel.idCode];
        addressModel.provinceName = model.addressModel.selectProvinceModel.name;
        addressModel.cityId = [NSString stringWithFormat:@"%ld",model.addressModel.selectCityModel.idCode];
        addressModel.cityName = model.addressModel.selectCityModel.name;
        if (model.addressModel.selectCountyModel) {
            addressModel.countyId = model.addressModel.selectCountyModel.idCode;
            addressModel.countyName = model.addressModel.selectCountyModel.name;
        }else {
            addressModel.countyId = -1;
            addressModel.countyName = @"";
        }
        
        //修改数据
        CYTLogisticsNeedWriteCellModel *itemModel = self.viewModel.cellModelArray[self.viewModel.addressIndex];
        itemModel.addressModel.mainAddress = [NSString stringWithFormat:@"%@ %@ %@",addressModel.provinceName,addressModel.cityName,addressModel.countyName];
        itemModel.addressModel.provinceId = addressModel.provinceId.integerValue;
        itemModel.addressModel.cityId = addressModel.cityId.integerValue;
        itemModel.addressModel.countyId = addressModel.countyId;
        itemModel.addressModel.detailAddress = @"";
        itemModel.select = YES;
        
        ///刷新table
        [self.mainView.tableView reloadSections:[NSIndexSet indexSetWithIndex:0] withRowAnimation:UITableViewRowAnimationNone];
        
        //设置是否可提交
        self.bottomView.valid = self.viewModel.valid;
        
    }];
    [self.navigationController pushViewController:choose animated:YES];
    
}

#pragma mark- 选择车型
- (void)gotoBrandCtr {
    CYTBrandSelectViewController *brandSelect = [CYTBrandSelectViewController new];
    __weak typeof(self)bself = self;
    brandSelect.ffobj = bself;
    brandSelect.viewModel.type = CYTBrandSelectTypeCar;
    brandSelect.viewModel.brandResultModel = [self.viewModel.brandSelectModel copy];
    
    @weakify(self);
    [brandSelect setBrandSelectBlock:^(CYTBrandSelectResultModel *brandModel) {
        @strongify(self);
        //处理选择的车款
        self.viewModel.brandSelectModel = brandModel;
        [self handleCarBrandModel:brandModel];
    }];
    
    [self.navigationController pushViewController:brandSelect animated:YES];
}

- (void)handleCarBrandModel:(CYTBrandSelectResultModel *)brandModel {
    CYTCarBrandModel *carModel = [CYTCarBrandModel new];
    
    carModel.brandId = [NSString stringWithFormat:@"%ld",brandModel.subBrandId];
    carModel.seriesId = [NSString stringWithFormat:@"%ld",brandModel.seriesModel.serialId];
    carModel.carId = [NSString stringWithFormat:@"%ld",brandModel.carModel.carId];
    
    if (brandModel.carModel.carId == -1) {
        //自定义车款
        carModel.customCar = YES;
        carModel.customCarName = brandModel.carModel.carName;
        carModel.totalName = [NSString stringWithFormat:@"%@ %@",brandModel.seriesModel.serialName,brandModel.carModel.carName];
    }else {
        //不是自定义车款
        carModel.customCar = NO;
        carModel.totalName = [NSString stringWithFormat:@"%@ %@",brandModel.seriesModel.serialName,brandModel.carModel.carName];
    }
    
    CYTLogisticsNeedWriteCellModel *model = self.viewModel.cellModelArray[2];
    model.carModel = carModel;
    model.select = YES;
    model.contentString = carModel.totalName;
    [self.mainView.tableView reloadSections:[NSIndexSet indexSetWithIndex:1] withRowAnimation:UITableViewRowAnimationNone];
    self.bottomView.valid = self.viewModel.valid;
}

#pragma mark- delegate

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section {
    return CYTAutoLayoutV(20);
}

- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section {
    return 0.01;
}

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
    return self.sectionNumber;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    if (section == 1) {
        return 3;
    }else if (section == 2) {
        return 1;
    }
    
    return 2;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    NSInteger index = [self indexWithIndexPath:indexPath];
    CYTLogisticsNeedWriteCellModel *model = self.viewModel.cellModelArray[index];
    
    if (indexPath.section == 0) {
        CYTLogisticsNeedAddressCell *cell = [tableView dequeueReusableCellWithIdentifier:[CYTLogisticsNeedAddressCell identifier] forIndexPath:indexPath];
        cell.model = model;
        cell.hideBottomLine = (indexPath.row == 1);
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        return cell;
    }else if (indexPath.section == 1) {
        if (indexPath.row == 0) {
            FFCell_Style_SimpleChoose *cell = [tableView dequeueReusableCellWithIdentifier:[FFCell_Style_SimpleChoose identifier]forIndexPath:indexPath];
            cell.cellView.flagLabel.text = model.title;
            
            UIColor *textColor = (model.select)?kColor_666666:kColor_b6b6b6;
            textColor = (self.viewModel.needGetLogisticInfo)?kColor_b6b6b6:textColor;
            cell.cellView.contentLabel.textColor = textColor;
            
            NSString *string = model.contentString;
            if (indexPath.row == 1  && string.length >0) {
                //数量
                string = [NSString stringWithFormat:@"%@辆",string];
            }
            cell.cellView.contentLabel.text = string;
            cell.selectionStyle = UITableViewCellSelectionStyleNone;
            return cell;
        }else {
            return [self inputCellWithTableView:tableView andIndexPath:indexPath andModel:model];
        }
    }else if (indexPath.section == 2) {
        CYTLogisticsNeedServiceCell *cell = [tableView dequeueReusableCellWithIdentifier:[CYTLogisticsNeedServiceCell identifier] forIndexPath:indexPath];
        cell.titleLab.text = model.title;
        cell.flagImageView.image = [UIImage imageNamed:model.imageName];
        cell.subTitleLabel.text = model.subtitle;
        NSString *chooseImage = model.select ? @"pay_box_select" :@"pay_box_nor";
        cell.chooseImageView.image = [UIImage imageNamed:chooseImage];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        return cell;
    }
    
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:[UITableViewCell identifier] forIndexPath:indexPath];
    return cell;
}

- (FFCell_Style_Input *)inputCellWithTableView:(UITableView *)tableView andIndexPath:(NSIndexPath *)indexPath andModel:(CYTLogisticsNeedWriteCellModel *)model {
    FFCell_Style_Input *cell = [tableView dequeueReusableCellWithIdentifier:[FFCell_Style_Input identifier] forIndexPath:indexPath];
    cell.cellView.flagLabel.text = model.title;
    if (indexPath.row==2) {
        NSString *priceS = @"总价";
        UIFont *font = cell.cellView.flagLabel.font;
        NSRange range = [model.title rangeOfString:priceS];
        [cell.cellView.flagLabel updateWithRange:range font:font color:CYTRedColor];
    }
    
    cell.cellView.textFiled.placeholder = model.placeholder;
    cell.cellView.textFiled.textColor = (self.viewModel.needGetLogisticInfo)?kColor_b6b6b6:kColor_666666;
    cell.cellView.textFiled.text = model.contentString;
    cell.cellView.textFiled.placeholderColor = kColor_b6b6b6;
    cell.cellView.textFiled.keyboardType = (indexPath.row == 1)?UIKeyboardTypeNumberPad:UIKeyboardTypeDecimalPad;
    cell.cellView.textFiled.userInteractionEnabled = (!self.viewModel.needGetLogisticInfo);
    
    cell.cellView.assistantLabel.text = model.subtitle;
    //如果是价格，修改万元颜色
    if (indexPath.row == 1) {
        //车辆
        cell.cellView.assistantLabel.textColor = kTitleMainColor;
    }else {
        //价格
        cell.cellView.assistantLabel.textColor = kTitleMainColor;
        NSRange range = [model.subtitle rangeOfString:@"万"];
        [cell.cellView.assistantLabel updateWithRange:range font:CYTFontWithPixel(28) color:CYTRedColor];
    }
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    
    @weakify(self);
    __block UITextField *textFiled = cell.cellView.textFiled;
    [cell setTextBlock:^(NSString *text) {
        @strongify(self);
        if (indexPath.row == 1) {
            //数量
            //最大值99
            if (text.length>2) {
                NSString *textString = [text substringToIndex:2];
                textFiled.text = textString;
                return ;
            }
            //不能为0
            if ([text isEqualToString:@"0"]) {
                textFiled.text = @"";
                return ;
            }
            [self handleCarNumber:[text integerValue]];
        }else {
            //车辆总价
            [self changePrice:text];
        }
    }];
    
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    BOOL keyboard = [CYTAppManager sharedAppManager].keyboardIsVisible;
    if (keyboard) {
        [self.view endEditing:YES];
        return;
    }
    
    
    NSInteger index = [self indexWithIndexPath:indexPath];
    CYTLogisticsNeedWriteCellModel *model = self.viewModel.cellModelArray[index];
    
    if (indexPath.section == 0) {
        self.viewModel.addressIndex = indexPath.row;
        [self gotoAddressCtrWithIndex:indexPath.row];
        
    }else if (indexPath.section == 1) {
        if (self.viewModel.needGetLogisticInfo) {
            //叫个物流
            return;
        }
        
        if (indexPath.row == 0) {
            //处理车型
            [self gotoBrandCtr];
        }
    }else if (indexPath.section == 2) {
        model.select = !model.select;
        [self.mainView.tableView reloadSections:[NSIndexSet indexSetWithIndex:2] withRowAnimation:UITableViewRowAnimationNone];
    }
    
}

#pragma mark- delegate
- (void)mainViewWillRefresh:(FFMainView *)mainView {
    [self getData];
}

- (void)mainViewWillReload:(FFMainView *)mainView {
    [self getData];
}

- (void)getData {
    if (self.viewModel.needGetLogisticInfo) {
        //重新获取物流信息
        [self.viewModel.requestLogisticInfo execute:nil];
    }
}

#pragma mark- get
- (FFMainView *)mainView {
    if (!_mainView) {
        FFMainViewConfigViewModel *configVM = [FFMainViewConfigViewModel new];
        configVM.style = UITableViewStyleGrouped;
        _mainView = [[FFMainView alloc] initWithViewModel:configVM];
        _mainView.delegate = self;
        [CYTTools configForMainView:_mainView ];
        _mainView.dznCustomViewModel.shouldDisplay = NO;
        _mainView.mjrefreshSupport = MJRefreshSupportNone;        
        [_mainView registerCellWithIdentifier:@[[CYTLogisticsNeedAddressCell identifier],
                                                [FFCell_Style_SimpleChoose identifier],
                                                [FFCell_Style_Input identifier],
                                                [CYTLogisticsNeedServiceCell identifier]]];
    }
    return _mainView;
}

- (CYTLogisticsNeedBottomView *)bottomView {
    if (!_bottomView) {
        _bottomView = [CYTLogisticsNeedBottomView new];
        _bottomView.valid = NO;
        @weakify(self);
        [_bottomView setClickedBlock:^{
            @strongify(self);
            [self.viewModel.requestCommand execute:nil];
        }];
    }
    return _bottomView;
}

- (CYTLogisticsProtocalView *)protocalView {
    if (!_protocalView) {
        _protocalView = [CYTLogisticsProtocalView new];
        @weakify(self);
        [_protocalView setSelectBlock:^(BOOL agree) {
            @strongify(self);
            self.viewModel.agreeProtocal = agree;
            self.bottomView.valid = self.viewModel.valid;
        }];
        [_protocalView setAgreeProtocalBlock:^{
            @strongify(self);
            [self gotoProtocalView];
        }];
    }
    return _protocalView;
}

- (CYTLogisticsNeedWriteVM *)viewModel {
    if (!_viewModel) {
        _viewModel = [CYTLogisticsNeedWriteVM new];
    }
    return _viewModel;
}

@end
